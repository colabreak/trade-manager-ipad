<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>オプチャ管理（超省スペース・iPad）</title>
<style>
  :root{
    --fg:#222; --muted:#777; --line:#ddd; --bg:#fafbfc; --danger:#d93025;
  }
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--fg); font:12px/1.2 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Meiryo",sans-serif}
  .wrap{padding:8px}
  h1{margin:0 0 6px 0; font-size:14px}
  .toolbar{display:flex; gap:6px; align-items:center; flex-wrap:wrap; margin-bottom:6px}
  .toolbar input[type="search"]{height:22px; font-size:12px; padding:2px 6px; width:22ch}
  .toolbar button{height:24px; padding:0 8px; font-size:12px; border-radius:6px; border:1px solid var(--line); background:#fff}
  table{width:100%; border-collapse:collapse; table-layout:fixed}
  th,td{border:1px solid var(--line); padding:4px}
  th{background:#f1f3f5; font-weight:600}
  td{vertical-align:middle}
  .col-date{width:16ch}
  .col-name{width:auto}
  .col-l1,.col-l2{width:4ch; text-align:center}
  .col-del{width:6ch; text-align:center}
  input[type="date"]{width:14ch; font-size:12px; padding:2px}
  .btn-date{margin-left:4px; font-size:11px; padding:2px 6px}
  .name{width:100%; font-size:12px; padding:2px}
  .link{width:3ch; text-align:center; font-size:12px; padding:2px}
  .note{width:18ch; font-size:12px; padding:2px}
  .del{font-size:11px; padding:2px 6px; color:#fff; background:#888; border:0; border-radius:4px}
  .cooldown{color:var(--danger); font-weight:600}
  .clear{color:#111}
  .sr{color:var(--muted); font-size:11px; margin-left:6px}
</style>
</head>
<body>
<div class="wrap">
  <h1>オプチャ管理</h1>
  <div class="toolbar">
    <input id="q" type="search" placeholder="検索（部分一致：名前・リンク）" />
    <button id="add">1行追加</button>
    <button id="save">保存</button>
    <span class="sr">最終日付は「更新」ボタンで今日に設定。15日未満は赤表示。</span>
  </div>

  <table>
    <thead>
      <tr>
        <th class="col-date">最終日付 / 更新</th>
        <th class="col-name">名前</th>
        <th class="col-l1">リンク1</th>
        <th class="col-l2">リンク2</th>
        <th class="col-del">削除</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
const STORAGE_KEY = 'tradeManagerData.v2';
let rows = [];
let filterText = '';

function todayStr(){
  const d = new Date();
  const z = (n)=> String(n).padStart(2,'0');
  return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
}

function daysSince(iso){
  if(!iso) return 9999;
  const t = new Date(iso);
  if(isNaN(t)) return 9999;
  const diffMs = Date.now() - t.getTime();
  return Math.floor(diffMs / 86400000); // 1000*60*60*24
}

function load(){
  try{ rows = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
  catch{ rows = []; }
}
function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
}

function addRow(){
  rows.push({ date: todayStr(), name: '', link1: '', link2: '' });
  render();
}

function confirmDel(idx){
  if(confirm('この行を削除しますか？')){
    rows.splice(idx,1);
    render();
  }
}

function matchesFilter(r){
  if(!filterText) return true;
  const t = filterText.toLowerCase();
  return (r.name||'').toLowerCase().includes(t) ||
         (r.link1||'').toLowerCase().includes(t) ||
         (r.link2||'').toLowerCase().includes(t);
}

function render(){
  const tb = document.getElementById('tbody');
  tb.innerHTML='';
  rows.forEach((r,idx)=>{
    if(!matchesFilter(r)) return;
    const tr = document.createElement('tr');

    // 最終日付 + 更新
    const tdDate = document.createElement('td');
    const inputDate = document.createElement('input');
    inputDate.type='date';
    inputDate.value = r.date || '';
    const d = daysSince(r.date);
    inputDate.className = d < 15 ? 'cooldown' : 'clear';
    inputDate.oninput = (e)=>{ r.date = e.target.value; inputDate.className = daysSince(r.date) < 15 ? 'cooldown' : 'clear'; };
    const btnUpd = document.createElement('button');
    btnUpd.className = 'btn-date';
    btnUpd.textContent = '更新';
    btnUpd.onclick = ()=>{ r.date = todayStr(); inputDate.value = r.date; inputDate.className = 'cooldown'; };
    tdDate.append(inputDate, btnUpd);

    // 名前
    const tdName = document.createElement('td');
    const inputName = document.createElement('input');
    inputName.className='name';
    inputName.value = r.name || '';
    inputName.oninput = (e)=>{ r.name = e.target.value; };
    tdName.appendChild(inputName);

    // リンク1
    const tdL1 = document.createElement('td');
    const inputL1 = document.createElement('input');
    inputL1.className='link';
    inputL1.inputMode='numeric';
    inputL1.maxLength=2;
    inputL1.value = r.link1 || '';
    inputL1.oninput = (e)=>{ e.target.value = e.target.value.replace(/[^0-9]/g,'').slice(0,2); r.link1 = e.target.value; };
    tdL1.appendChild(inputL1);

    // リンク2
    const tdL2 = document.createElement('td');
    const inputL2 = document.createElement('input');
    inputL2.className='link';
    inputL2.inputMode='numeric';
    inputL2.maxLength=2;
    inputL2.value = r.link2 || '';
    inputL2.oninput = (e)=>{ e.target.value = e.target.value.replace(/[^0-9]/g,'').slice(0,2); r.link2 = e.target.value; };
    tdL2.appendChild(inputL2);

    // 削除
    const tdDel = document.createElement('td');
    const btnDel = document.createElement('button');
    btnDel.className='del';
    btnDel.textContent='削除';
    btnDel.onclick = ()=> confirmDel(idx);
    tdDel.appendChild(btnDel);

    tr.append(tdDate, tdName, tdL1, tdL2, tdDel);
    tb.appendChild(tr);
  });
}

// UI events
window.addEventListener('DOMContentLoaded', ()=>{
  load();
  render();
  document.getElementById('add').onclick = ()=>{ addRow(); };
  document.getElementById('save').onclick = ()=>{ save(); alert('保存しました'); };
  document.getElementById('q').addEventListener('input', (e)=>{ filterText = e.target.value.trim(); render(); });
});
</script>
</body>
</html>

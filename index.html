<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>オプチャ管理</title>
<style>
  :root {
    --bg: #f4f6fa;
    --card: #ffffff;
    --accent: #007aff;
    --danger: #ff3b30;
    --text: #1c1c1e;
    --border: #d2d2d7;
  }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    margin: 0;
    background: var(--bg);
    color: var(--text);
    padding: 12px;
  }
  .container {
    background: var(--card);
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    padding: 16px;
    max-width: 640px;
    margin: 0 auto;
  }
  h1 {
    margin: 0 0 12px 0;
    font-size: 16px;
    text-align: center;
  }
  .toolbar {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 12px;
    justify-content: center;
  }
  .toolbar input[type="search"] {
    flex: 1;
    min-width: 180px;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 6px 10px;
    font-size: 13px;
  }
  .toolbar button {
    border: none;
    border-radius: 10px;
    background: var(--accent);
    color: #fff;
    padding: 6px 12px;
    font-size: 13px;
    cursor: pointer;
    transition: 0.2s;
  }
  .toolbar button:hover { opacity: 0.8; }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  th, td {
    border-bottom: 1px solid var(--border);
    padding: 6px;
    text-align: center;
  }
  th {
    background: #f8f9fb;
    font-weight: 600;
  }
  input[type="date"], input[type="text"] {
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 4px 6px;
    font-size: 13px;
    text-align: center;
    width: 100%;
  }
  .btn-update {
    border: none;
    background: var(--accent);
    color: white;
    border-radius: 8px;
    padding: 3px 8px;
    font-size: 12px;
  }
  .btn-del {
    border: none;
    background: var(--danger);
    color: white;
    border-radius: 8px;
    padding: 3px 8px;
    font-size: 12px;
  }
  .cooldown { color: var(--danger); font-weight: 600; }
  .clear { color: var(--text); }
  .link-input {
    width: 3ch;
    border-radius: 6px;
    text-align: center;
  }
</style>
</head>
<body>
  <div class="container">
    <h1>オプチャ管理</h1>
    <div class="toolbar">
      <input id="search" type="search" placeholder="検索（名前・リンク部分一致）">
      <button id="add">1行追加</button>
      <button id="save">保存</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>最終日付 / 更新</th>
          <th>名前</th>
          <th>リンク1</th>
          <th>リンク2</th>
          <th>削除</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

<script>
const STORAGE_KEY = 'opchatManagerV3';
let rows = [];
let filterText = '';

function todayStr(){
  const d = new Date();
  const z = (n)=> String(n).padStart(2,'0');
  return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
}

function daysSince(iso){
  if(!iso) return 9999;
  const t = new Date(iso);
  if(isNaN(t)) return 9999;
  const diffMs = Date.now() - t.getTime();
  return Math.floor(diffMs / 86400000);
}

function load(){
  try { rows = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
  catch { rows = []; }
}

function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
}

function addRow(){
  rows.push({ date: todayStr(), name: '', link1: '', link2: '' });
  render();
}

function confirmDel(idx){
  if(confirm('この行を削除しますか？')){
    rows.splice(idx, 1);
    render();
  }
}

function matchesFilter(r){
  if(!filterText) return true;
  const t = filterText.toLowerCase();
  return (r.name || '').toLowerCase().includes(t) ||
         (r.link1 || '').toLowerCase().includes(t) ||
         (r.link2 || '').toLowerCase().includes(t);
}

function render(){
  const tb = document.getElementById('tbody');
  tb.innerHTML = '';
  rows.forEach((r, idx) => {
    if(!matchesFilter(r)) return;
    const tr = document.createElement('tr');

    // 日付＋更新
    const tdDate = document.createElement('td');
    const inputDate = document.createElement('input');
    inputDate.type = 'date';
    inputDate.value = r.date || '';
    const d = daysSince(r.date);
    inputDate.className = d < 15 ? 'cooldown' : 'clear';
    inputDate.oninput = (e)=>{
      r.date = e.target.value;
      inputDate.className = daysSince(r.date) < 15 ? 'cooldown' : 'clear';
    };
    const btnUpdate = document.createElement('button');
    btnUpdate.className = 'btn-update';
    btnUpdate.textContent = '更新';
    btnUpdate.onclick = ()=>{
      r.date = todayStr();
      inputDate.value = r.date;
      inputDate.className = 'cooldown';
    };
    tdDate.append(inputDate, btnUpdate);

    // 名前
    const tdName = document.createElement('td');
    const inputName = document.createElement('input');
    inputName.type = 'text';
    inputName.value = r.name || '';
    inputName.oninput = (e)=> r.name = e.target.value;
    tdName.appendChild(inputName);

    // リンク1
    const tdL1 = document.createElement('td');
    const inputL1 = document.createElement('input');
    inputL1.className = 'link-input';
    inputL1.inputMode = 'numeric';
    inputL1.maxLength = 2;
    inputL1.value = r.link1 || '';
    inputL1.oninput = (e)=>{
      e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0,2);
      r.link1 = e.target.value;
    };
    tdL1.appendChild(inputL1);

    // リンク2
    const tdL2 = document.createElement('td');
    const inputL2 = document.createElement('input');
    inputL2.className = 'link-input';
    inputL2.inputMode = 'numeric';
    inputL2.maxLength = 2;
    inputL2.value = r.link2 || '';
    inputL2.oninput = (e)=>{
      e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0,2);
      r.link2 = e.target.value;
    };
    tdL2.appendChild(inputL2);

    // 削除
    const tdDel = document.createElement('td');
    const btnDel = document.createElement('button');
    btnDel.className = 'btn-del';
    btnDel.textContent = '削除';
    btnDel.onclick = ()=> confirmDel(idx);
    tdDel.appendChild(btnDel);

    tr.append(tdDate, tdName, tdL1, tdL2, tdDel);
    tb.appendChild(tr);
  });
}

window.addEventListener('DOMContentLoaded', ()=>{
  load();
  render();
  document.getElementById('add').onclick = ()=> addRow();
  document.getElementById('save').onclick = ()=> { save(); alert('保存しました'); };
  document.getElementById('search').addEventListener('input', (e)=>{ filterText = e.target.value.trim(); render(); });
});
</script>
</body>
</html>
